<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Miracle Messages Web App</title>
  <link rel="shortcut icon" href="/mm-logo.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="bundle-edit.css">
  <link rel="stylesheet" href="edit.scss">

  <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>

  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
</head>

<script src="text/javascript" src="edit.js"></script>

<header class="mdc-top-app-bar mdc-elevation--z4" style="background-color:#00bfa5">
  <div class="mdc-top-app-bar__row" >
    <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
      <svg class="mm-logo" version="1.0" xmlns="http://www.w3.org/2000/svg"
       width="75pt" height="30pt" viewBox="-120 0 170 170"
       preserveAspectRatio="xMidYMid meet">
        <g transform="translate(-80,190) scale(0.100000,-0.100000)"
        fill="#ffffff" stroke="none">
        <path d="M725 1500 l-399 -400 39 -40 39 -40 56 55 c31 30 59 55 63 55 4 0 7
        -151 7 -335 l0 -335 595 0 595 0 0 335 c0 184 3 335 7 335 4 0 32 -25 63 -55
        l56 -55 39 40 40 40 -400 400 -400 400 -400 -400z m605 35 l195 -195 -400 0
        -400 0 195 195 c107 107 199 195 205 195 6 0 98 -88 205 -195z m-3 -512 l-197
        -198 -197 198 -198 197 395 0 395 0 -198 -197z m33 -128 c129 129 238 235 242
        235 5 0 8 -124 8 -275 l0 -275 -480 0 -480 0 0 277 0 278 238 -238 237 -237
        235 235z"/>
        </g>
      </svg>
      <span class="mdc-top-app-bar__title mm-title" style="font-size: 24pt">Miracle Messages</span>
      <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end">
      <button class="mdc-button" onclick = "signout()">
        <span class="mdc-button__label">Log Out</span>
      </button>
    </section>
</div>

<div class="mdc-tab-bar" role="tablist" style="background-color:#e0f2f1;">
  <div class="mdc-tab-scroller">
    <div class="mdc-tab-scroller__scroll-area">
      <div class="mdc-tab-scroller__scroll-content">

        <button class="mdc-tab mdc-tab--active head-tab" role="tab" aria-selected="true" tabindex="0" style="box-shadow: 0 0 1px 0" onclick="window.location.href='home.html'">
          <span class="mdc-tab__content">
            <span class="mdc-tab__icon material-icons" aria-hidden="true">people</span>
            <span class="mdc-tab__text-label">Cases</span>
          </span>
          <span class="mdc-tab-indicator mdc-tab-indicator--active">
            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
          </span>
          <span class="mdc-tab__ripple"></span>
        </button>

        <button class="mdc-tab head-tab" role="tab" tabindex="0" style="box-shadow: 0 0 1px 0" onclick="window.location.href='create_user.html'">
          <span class="mdc-tab__content">
            <span class="mdc-tab__icon material-icons" aria-hidden="true">account_box</span>
            <span class="mdc-tab__text-label">Add a Volunteer</span>
          </span>
          <span class="mdc-tab__ripple"></span>
        </button>

        <button class="mdc-tab head-tab" role="tab" tabindex="0" style="box-shadow: 0 0 1px 0" onclick="window.open('https://miraclemessages.org/refer', '_blank');">
          <span class="mdc-tab__content">
            <span class="mdc-tab__icon material-icons" aria-hidden="true">person_add</span>
            <span class="mdc-tab__text-label">Add a Case</span>
          </span>
          <span class="mdc-tab__ripple"></span>
        </button>

      </div>
    </div>
  </div>
</div>
</header>

<body>
    <!-- Setup Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

    <script>
        var config = {
            apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
            authDomain: "miraclemessages-v2.firebaseapp.com",
            databaseURL: "https://miraclemessages-v2.firebaseio.com",
            projectId: "miraclemessages-v2",
            storageBucket: "miraclemessages-v2.appspot.com",
            messagingSenderId: "669586730683"
        };
        app = firebase.initializeApp(config);
    </script>

    <!-- Import headerToColl (dictionary), getURLParams, formatWords,
         escapeSingleQuotes, appendHTML, addFromRef, getData -->
    <script src='utils/database.js'></script>

    <script>
        // Initialize Firebase
        const db = firebase.database();
        const URLParams = getURLParams();
        const caseID = URLParams["caseID"];
        const isAdmin = (URLParams["isAdmin"] === 'true');

        // Setup a dictionary for the unedited data so that when data is saved,
        // only changed data will be saved.
        let originalData = {};

        // Allow each input field to be edited.
        function enableEdit() {
            // Get a list of all the input elements.
            let inputs = document.getElementsByTagName("input");

            for (let i = 0; i < inputs.length; i++) {
                // Make each input editable.
                inputs[i].readOnly = false;
            }
        }

        // Disallow edits of input fields.
        function disableEdit(fields) {
            for (let i = 0; i < fields.length; i++) {
                fields[i].readOnly = true;
            }
        }

        // Find data that was altered.
        function getAlteredData(fields) {
            let alteredData = {};

            console.log('get altered data: original data:', originalData);

            for (let i = 0; i < fields.length; i++) {
                // Find the firebase collection that this field is in.
                parentColl = headerToColl[fields[i].parentNode.id];

                // Check if this field was changed.
                let path = parentColl + '/' + fields[i].id;

                if (originalData[path] != fields[i].value) {
                    // This field was changed.
                    alteredData[path] = fields[i].value;
                }
            }

            console.log('get altered data: altered data:', alteredData);
            return alteredData;
        }

        // Write altered data to the database.
        function writeData(fields) {
            // Find the altered data.
            const alteredData = getAlteredData(fields);

            // Collect the current date time
            var today = new Date;
            var sec = today.getSeconds();
            var min = today.getMinutes();
            var hr = today.getHours();
            var day = today.getDate();
            var month = today.getMonth() + 1;
            var year = today.getFullYear();

            var dateTime = hr + ':' + min + ':' + sec + '::' + month + '/' + day + '/' + year;

            db.ref('proposed/id').once('value').then(function(snapshot) {
                // Get the next proposal ID. The '+ 1 - 1' is to convert null
                // to 0 becuase if the 'proposed' collection is not in the
                // database, then 'proposed/id' will be null.
                proposalID = snapshot.val() + 1 - 1;

                // Update the fields.
                for (let key in alteredData) {
                    // The key is in the form 'cases/id/field', so we have to
                    // extract the path and field.
                    const pathEnd = key.lastIndexOf('/');
                    const path = key.substring(0, pathEnd);
                    const field = key.substring(pathEnd + 1);

                    let newData = {};
                    newData[field] = alteredData[key];

                    // If a nonadmin updates case status info, add it to the
                    // 'proposed' queue for an admin to approve it.
                    if (isAdmin || !path.startsWith('cases')) {
                        // Write the data directly to the database.
                        // and store a copy in the audit log (with the
                        // current dateTime stored as well)
                        db.ref(path).update(newData);
                        newData['dateTime'] = dateTime;
                        db.ref('audits/' + path).set(newData);
                    }
                    else {
                        // Enqueue the proposed edit to be approved by admin.
                        // Include the dateTime (should be removed when
                        // storing the data in the actual collections tho).
                        newData['dateTime'] = dateTime;
                        db.ref('proposed/' + proposalID + '/' + path).set(newData);
                        db.ref('proposed/' + proposalID).update({caseID: caseID});

                        // Update the proposal ID.
                        proposalID += 1
                        db.ref('proposed').update({id: proposalID});
                    }
                }

                // Update the originalData dictionary so that if you change field A
                // and then save, then change field A back to its original value
                // and save again, the final value for A in the database will be
                // the original.
                for (let key in alteredData) {
                    originalData[key] = alteredData[key];
                }
            });
        }

        // Disable input field editing and write data to the database.
        function save() {
            // Get a list of all the input elements.
            let fields = document.getElementsByTagName("input");

            // Disable editing and save changes to the database.
            disableEdit(fields);
            writeData(fields);
            alert("Successfully saved changes");
        }

        // Load a case.
        getData(caseID, originalData);
    </script>

    <div class="mdc-card case-info">

    <div id='Case Overview'></div>
    <div id='Client'></div>
    <div id='Loved Ones'></div>
    <div id='Notes'></div>
    <div id='Records'></div>
    <div id='Volunteer'></div>

    <div class="mdc-card__actions">
        <button class="mdc-button mdc-card__action mdc-card__action--button" id="edit" onclick="enableEdit()">
            <span class="mdc-button__label">Edit</span>
        </button>

        <button class="mdc-button mdc-card__action mdc-card__action--button" id="save" onclick="save()">
            <span class="mdc-button__label">Save</span>
        </button>
    </div>

    </div>


    <script src="bundle-edit.js"></script>
</body>
</html>
