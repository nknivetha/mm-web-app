<html>
<head>
<title>Cases</title>

<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
    authDomain: "miraclemessages-v2.firebaseapp.com",
    databaseURL: "https://miraclemessages-v2.firebaseio.com",
    projectId: "miraclemessages-v2",
    storageBucket: "miraclemessages-v2.appspot.com",
    messagingSenderId: "669586730683"
  };
  app = firebase.initializeApp(config);
</script>

</head>

<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>

<script lang="text/javascript">


var db = firebase.database(app);
var checkFrom = ""; // field to check from
var query; // user input of what to check for
var auth = app.auth();
var isAdmin = false;

// Check if a user is signed in - only allow access to the page if they are
// If not logged, redirect to the login page
auth.onAuthStateChanged(function(user) {
  // If a user is signed in, log it and record their email address as query
  if (user) {
    query = user.email
    console.log(user)
  } 

  // Otherwise, alert the user they're not logged in and redirect to login page
  else {
    alert("not logged in");
    window.location.href = 'index.html';
  }
});

function getCases()
{
contents = "";
var dump = document.getElementById("results");

searchFrom = 'volunteers';
checkFrom = 'volunteerID';

var searchRef = db.ref(searchFrom);

searchRef.orderByKey().on("value",searchFilter);
}

// Goes through the field, and adds it to the list if it matches the criteria
function searchFilter(snapshot)
{

    var assigned = [];
    var unassigned = []
    var isUnassigned = []
    allData = snapshot.val();

    for (k in allData)
    {
        oneCase = allData[k];    // JSON
        var checking;

        if (checkFrom === 'volunteerID') {
          checking = String(oneCase.volunteerContactInfo).toLowerCase();
        }

        if (checking.includes(query.toLowerCase())) {
          assigned.push(String(oneCase.caseID));
        }
        if (checking === "") {
          isUnassigned.push("(unassigned case)");
          unassigned.push(String(oneCase.caseID));
        }
          
    }

    var dump = document.getElementById("results");

    var fixedCase = assigned[0].replace(/\d+$/, "")
    dump.innerHTML = '<tr><th><a href="edit.html?caseID=' + assigned[0] + '&isAdmin=' + String(isAdmin) + '">' + fixedCase + '</a> </th> </tr>';
    for (var i = 1; i < assigned.length; i++) {
      fixedCase = assigned[i].replace(/\d+$/, "")
      dump.innerHTML += '<tr><th><a href="edit.html?caseID=' + assigned[i] + '&isAdmin=' + String(isAdmin) + '">' + fixedCase + '</a> </th> </tr>';
    }

    for (var i = 0; i < unassigned.length; i++) {
      fixedCase = unassigned[i].replace(/\d+$/, "")
      dump.innerHTML += '<tr><th><a href="edit.html?caseID=' + unassigned[i] + '&isAdmin=' + String(isAdmin) + '">' + fixedCase + ' ' + isUnassigned[i] + '</a> </th> </tr>';
    }
}


</script>
<body onload="getCases();">

<center>

<br>

Results:<br/>
<div style="height:400px; width:800px; overflow:auto; border:1px solid black">
  <table id="results" style="width:70%">
  </table>
</div>

</body>
</html>
