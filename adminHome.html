<html>
<head>
<title>Web App</title>

<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>
<script>
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
		authDomain: "miraclemessages-v2.firebaseapp.com",
		databaseURL: "https://miraclemessages-v2.firebaseio.com",
		projectId: "miraclemessages-v2",
		storageBucket: "miraclemessages-v2.appspot.com",
		messagingSenderId: "669586730683"
	};
	var app = firebase.initializeApp(config);
	const db = firebase.database();
</script>

</head>
<body>

<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>

<script lang="text/javascript">

var auth = app.auth();
var isAdmin = false;

// Admin Authentication
// Check if admin is signed in - only allow access to the page if they are
// If not logged into the admin account, redirect to the login page
auth.onAuthStateChanged(function(user) {
	// Check if a user is signed in and that that user is admin.
	if (user) {
		const userTypeRef = db.ref('usertypes/' + user.uid + '/type');
		userTypeRef.once('value').then(function(snapshot) {
			if (snapshot.val() == 'admin') {
				isAdmin = true;
				console.log('user: ' + user);
			}
			else {
				console.log("the user is not admin");
				notAdmin();
			}
		});
	}
	else {
		console.log("the user is not logged in");
		notAdmin();
	}
});


// Give an error that the user is not admin, and redirect to the main page.
function notAdmin() {
	alert("not logged in as admin");
	window.location.href = 'index.html';
}

// Functions to take you to various pages when the admin clicks on the
// various page buttons

// Takes you to admin search
function visitSearch(){
	window.location='search.html';
}

// Takes you to Miracle Message's add a new case form
function visitAdd(){
	window.location='https://miraclemessages.org/refer';
}

// Takes you to review proposed updates page (for changes made to a case
// status)
function visitReviewUpdates(){
  window.location='review_updates.html';
}

// Takes you to create a new user account page
function visitCreateUser(){
  window.location='create_user.html';
}


// Check for a successful sign out and redirect the user to login page
function signoutGood() {
	const user = data.user;

  // Check to make sure no user is currently signed in - if so, redirect to
  // the login page
  if (user == null) {
  	alert ("Successfully signed out");
  	window.location.href = "index.html";
  }
}

// Handle an unsuccessful signout
function signoutError(error){
	// Get the error message and alert the user
	var errorCode = error.code;
	var errorMessage = error.message;
	alert(error.message);
}

// Signs out the current user
function signout(){
  // If can sign out without error, call signoutGood()
  // Otherwise, handle any errors in signoutError()
  auth.signOut().catch(signoutError).then(signoutGood);
}

</script>

	<!-- Buttons to navigate to different pages -->
	<button type="button" id="search" onclick="visitSearch()">Search</button>
  <button type="button" id="add" onclick="visitAdd()">Add</button>
  <button type="button" id="status updates" onclick="visitReviewUpdates()">Status Updates</button>
  <button type="button" id="create user" onclick="visitCreateUser()">Create New User</button>
  <button type="button" id="sign out" onclick="signout()">Sign Out</button>

</body>
</html>
