<html>
<head>
<title>Search</title>

<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
    authDomain: "miraclemessages-v2.firebaseapp.com",
    databaseURL: "https://miraclemessages-v2.firebaseio.com",
    projectId: "miraclemessages-v2",
    storageBucket: "miraclemessages-v2.appspot.com",
    messagingSenderId: "669586730683"
  };
  app = firebase.initializeApp(config);
</script>

</head>
<body>

<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>


<script lang="text/javascript">
var db = firebase.database(app);
var checkFrom = ""; // field to check from
var query; // user input of what to check for
var auth = app.auth();
var isAdmin = false;

// Admin Authentication
// Check if admin is signed in - only allow access to the page if they are
// If not logged into the admin account, redirect to the login page
auth.onAuthStateChanged(function(user) {
	// Check if a user is signed in and that that user is admin.
	if (user) {
		const userTypeRef = db.ref('usertypes/' + user.uid + '/type');
		userTypeRef.once('value').then(function(snapshot) {
			if (snapshot.val() == 'admin') {
				isAdmin = true;
				console.log('user: ' + user);
			}
			else {
				console.log("the user is not admin");
				notAdmin();
			}
		});
	}
	else {
		console.log("the user is not logged in");
		notAdmin();
	}
});

// Give an error that the user is not admin, and redirect to the main page.
function notAdmin() {
	alert("not logged in as admin");
	window.location.href = 'index.html';
}

// Goes through the data, and adds it to the result if it matches the criteria
function searchFilter(snapshot)
{

    var contents = []; // stores results //
    allData = snapshot.val(); // get all data from Firebase //

    // Go through all the data and find matching instances.
    for (k in allData)
    {
        oneCase = allData[k]; // one case from the database
        var checking; // the query to satisfy

        // If searching by delivery status, the query is one of the statuses.
        if (checkFrom === 'deliveryStatus'){
           checking = oneCase.deliveryStatus;
           if (checking == query){
                contents.push(String(oneCase.caseID));
           }
        }
        else {
          // If searching by name, the query is a lowercase string of the name.
            if (checkFrom === 'name'){
              checking = String(oneCase.name).toLowerCase();
          }
          else if (checkFrom === 'volunteerName'){
              checking = String(oneCase.volunteerName).toLowerCase();
          }
          // Add to list of results if it matches.
          if (checking.includes(query.toLowerCase())){
                    contents.push(String(oneCase.caseID));
          }
        }
    }

    // Get the HTML element that will store all our cases
    var dump = document.getElementById("results");

    // Link cases to their full logs and data so that they are viewable and editable.
    var fixedCase = contents[0].replace(/\d+$/, "")
    dump.innerHTML = '<tr><th><a href="edit.html?caseID=' + contents[0] + '&isAdmin=' + String(isAdmin) + '">' + fixedCase + '</a> </th> </tr>';
    for (var i = 1; i < contents.length; i++) {
      fixedCase = contents[i].replace(/\d+$/, "")
      dump.innerHTML += '<tr><th><a href="edit.html?caseID=' + contents[i] + '&isAdmin=' + String(isAdmin) + '">' + fixedCase + '</a> </th> </tr>';
    }
}

// Search based on the category and query provided.
function search()
{

    contents = "";

    var dump = document.getElementById("results");

    var myform = document.getElementById("newsearch");

    query = myform.elements["query"].value // value of query
    var fld = myform.elements["type"].value; // type of search

    switch(fld) {
      // Search by client name
      case 'client':
        searchFrom = 'clients';
        checkFrom = 'name';
        break;

      // Search by volunteer name
      case 'volunteer':
        searchFrom = 'volunteers';
        checkFrom = 'volunteerName';
        break;

      // Search by delivery status
      case 'status':
        searchFrom = 'cases';
        checkFrom = 'deliveryStatus';
        var sel = myform.elements["s_s"].value
        switch(sel) {
          case 'undeliv': // undelivered
            query = 0;
            break;
          case 'deliv': // delivered
            query = 1;
            break;
          case 'need': // needs to be delivered
            query = -1;
            break;
          case 'no': // no delivery
            query = -2;
            break;
        }
        break;
      default:
        break;
    }

    var searchRef = db.ref(searchFrom);

    // Conduct the search in the database.
    searchRef.orderByKey().on("value",searchFilter);
}

</script>


<center><form id="newsearch">
  Search by

  <!-- Displays all the search options -->
<select id="type" onchange="if (this.value=='status'){this.form['s_s'].style.visibility='visible';
this.form['query'].style.visibility='hidden'}else {this.form['s_s'].style.visibility='hidden';
this.form['query'].style.visibility='visible'};">
<option value="" selected="selected">Select...</option>
<option value="client">Client name</option>
<option value="case_date">Date of case (MM/YY)</option> /* TODO */
<option value="volunteer">Volunteer name</option>
<option value="worked_on_date">Last worked on date (MM/YY)</option> /* TODO */
<option value="status">Delivery status</option>
</select>

<input type="text" id="query" name="query" style="visibility:hidden;">
<select id="s_s" name="s_s" style="visibility:hidden;">
  <option value="undeliv">Undelivered</option>
  <option value="deliv">Delivered</option>
  <option value="need">Needs to be delivered</option>
  <option value="no">No delivery</option>
</select>
<!-- On click, the search runs -->
<input type="button" value="Search" onclick="search()">

</form>

<br>

<!-- Results from the search displayed here. -->
Results:<br/>
<div style="height:400px; width:500px; overflow:auto; border:1px solid black">
  <table id="results" style="width:40%">
  </table>
</div>
</form></center>
</body>
</html>
