<!DOCTYPE html>

<html>
<head>

    <title>Review Updates</title>
</head>

<body>
    <!-- Setup Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

    <script>
        var config = {
            apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
            authDomain: "miraclemessages-v2.firebaseapp.com",
            databaseURL: "https://miraclemessages-v2.firebaseio.com",
            projectId: "miraclemessages-v2",
            storageBucket: "miraclemessages-v2.appspot.com",
            messagingSenderId: "669586730683"
        };
        app = firebase.initializeApp(config);
    </script>

    <!-- Import headerToColl (dictionary), getURLParams, formatWords,
         escapeSingleQuotes, appendHTML, addFromRef, getData -->
    <script src='utils/database.js'></script>
    <script>
        let proposalID = 0;
        const db = firebase.database();
        const URLParams = getURLParams();
        const isAdmin = (URLParams["isAdmin"] === 'true');

        // Setup a dictionary for the unedited data so that when data is saved,
        // only changed data will be saved.
        let originalData = {};


        function readNext(proposalID) {
            const parentDir = 'proposed/' + proposalID;

            // Find the case ID.
            let caseID = null;
            db.ref(parentDir + '/caseID').once('value').then(function (snapshot) {
                caseID = snapshot.val();
                console.log('found the caseID:' + caseID);

                if (caseID != null) {
                    // Get the data from the proposed branch.
                    getData(caseID, parentDir, firstNoteOnly=true);
                }
            });
        }

        // Remove all of the case data from the screen.
        function clearHTML() {
            divNames = document.getElementsByTagName('div');

            for (let key in divNames) {
                divNames[key].innerHTML = '';
            }
        }

        function viewNext() {
            proposalID++;

            clearHTML();
            readNext(proposalID);
        }

        function viewPrevious() {
            proposalID--;

            clearHTML();
            readNext(proposalID);
        }

        function deleteFromProposed() {
            // Delete the current directory of the 'proposed' branch, along
            // with all child directories.
            db.ref('proposed/' + proposalID).remove();
        }


        // Approve the proposed change.
        function approve() {
            console.log('originalData:')

            for (let path in originalData) {
                console.log('(key, value): (' + path + ', ' + originalData[path] + ')');

                // Make sure this is not the date-time field, as we don't want
                // to add this to the regular database.
                if (path.includes('dateTime')) {
                    continue;
                }

                // Write the updated data. The 'path' variable holds the path
                // from the root of the database to the actual field that needs
                // to be updated, so the reference is from the database root.
                updatedData = {};
                updatedData[path] = originalData[path];
                db.ref('/').update(updatedData);

                // Clean up the 'proposed' branch of the database.
                deleteFromProposed();
            }
        }

        // Reject the proposed change.
        function discard() {
            // Simply delete the proposed change.
            deleteFromProposed();
        }

        readNext(proposalID);

    </script>


    <div id='Case Overview'></div>
    <div id='Client'></div>
    <div id='Loved Ones'></div>
    <div id='Notes'></div>
    <div id='Records'></div>
    <div id='Volunteer'></div>

    <button type="button" id="prev" onclick=viewPrevious()>Previous</button>
    <button type="button" id="accept" onclick=approve()>Accept</button>
    <button type="button" id="reject" onclick=discard()>Reject</button>
    <button type="button" id="next" onclick=viewNext()>Next</button>
</body>
</html>
