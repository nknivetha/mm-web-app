<!DOCTYPE html>

<html>
<head>

    <title>Review Updates</title>
</head>

<body>
    <!-- Setup Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

    <script>
        var config = {
            apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
            authDomain: "miraclemessages-v2.firebaseapp.com",
            databaseURL: "https://miraclemessages-v2.firebaseio.com",
            projectId: "miraclemessages-v2",
            storageBucket: "miraclemessages-v2.appspot.com",
            messagingSenderId: "669586730683"
        };
        app = firebase.initializeApp(config);
    </script>

    <!-- Import headerToColl (dictionary), getURLParams, formatWords,
         escapeSingleQuotes, appendHTML, addFromRef, getData -->
    <script src='utils/database.js'></script>
    <script>
        let proposalID = null;
        const db = firebase.database();
        const URLParams = getURLParams();
        const isAdmin = (URLParams["isAdmin"] === 'true');

        // Setup a dictionary for the unedited data so that when data is saved,
        // only changed data will be saved.
        let originalData = {};


        function readNext() {
            const parentDir = 'proposed/' + proposalID;

            // Find the case ID.
            let caseID = null;
            db.ref(parentDir + '/caseID').once('value').then(function (snapshot) {
                caseID = snapshot.val();
                console.log('found the caseID:' + caseID);

                if (caseID == null) {
                    // The queue is emtpy, so reset id and smallest_id.
                    db.ref('proposed').update({id: 0, smallest_id: 0});

                    // Display a message so the user knows the queue is empyt.
                    const section = document.getElementById('Empty Queue');
                    let html = '<h4>There are no more updates to be reviewed.</h4>';
                    section.innerHTML = html;

                    // Remove the case name and buttons.
                    document.getElementById('Case Name').style.display = 'none';
                    document.getElementById('accept').style.display = 'none';
                    document.getElementById('reject').style.display = 'none';
                }
                else {
                    // Show the case ID.
                    const html = '<h4>Case ID: ' + caseID + '</h4>';
                    document.getElementById('Case Name').innerHTML = html;

                    // Get the data from the proposed branch.
                    getData(caseID, originalData, parentDir, firstNoteOnly=true);
                }
            });
        }

        // Remove all of the case data from the screen.
        function clearHTML() {
            divNames = document.getElementsByTagName('div');

            for (let key in divNames) {
                divNames[key].innerHTML = '';
            }
        }

        function viewNext() {
            proposalID++;

            // Make sure the 'originalData' is clean.
            originalData = {};

            clearHTML();
            readNext();
        }

        function deleteFromProposed(propID) {
            // Delete the current directory of the 'proposed' branch, along
            // with all child directories.
            db.ref('proposed/' + propID).remove();

            // Update the smallest id.
            db.ref('proposed').update({smallest_id: propID + 1});
        }

        // Approve the proposed change.
        function approve() {
            console.log('originalData:')

            for (let path in originalData) {
                console.log('(key, value): (' + path + ', ' + originalData[path] + ')');

                // Make sure this is not the date-time field, as we don't want
                // to add this to the regular database.
                if (path.includes('dateTime')) {
                    continue;
                }

                // Write the updated data. The 'path' variable holds the path
                // from the root of the database to the actual field that needs
                // to be updated, so the reference is from the database root.
                updatedData = {};
                updatedData[path] = originalData[path];
                db.ref('/').update(updatedData);
            }

            // Clean up the 'proposed' branch and check the next update.
            deleteFromProposed(proposalID);
            viewNext();
        }

        // Reject the proposed change.
        function discard() {
            // Delete the proposed change and go to the next.
            deleteFromProposed(proposalID);
            viewNext();
        }

        // Read the first item in the queue.
        db.ref('proposed/smallest_id').once('value').then(function(snapshot) {
            // Get the next proposal ID. The '+ 1 - 1' is to convert null
            // to 0 becuase if the 'proposed' collection is not in the
            // database, then 'proposed/smallest_id' will be null.
            proposalID = snapshot.val() + 1 - 1;

            // Update the proposal ID.
            // const newID = (proposalID + Object.keys(alteredData).length) % 4000000000;
            // db.ref('proposed').update({id: newID});

            readNext();
        });

    </script>

    <div id='Case Name'></div>

    <div id='Case Overview'></div>
    <div id='Client'></div>
    <div id='Loved Ones'></div>
    <div id='Notes'></div>
    <div id='Records'></div>
    <div id='Volunteer'></div>
    <div id='Empty Queue'></div>

    <button type="button" id="accept" onclick=approve()>Accept</button>
    <button type="button" id="reject" onclick=discard()>Reject</button>
</body>
</html>
