<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Miracle Messages Web App</title>
    <link rel="shortcut icon" href="/mm-logo.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="bundle-edit.css">
    <link rel="stylesheet" href="volupdate.scss">

    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>

    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>

        // import {MatDatepickerModule} from '@angular/material/datepicker';

        $(function () {
            $("#datepicker").datepicker();
        });

        $(function () {
            $('input[type="radio"]').click(function () {
                if ($(this).attr('id') == 'one') {
                    $('#casemore').show();
                }

                else {
                    $('#casemore').hide();
                }
            });
        });
        function showDiv(divId, element, match) {
            document.getElementById(divId).style.display = element.value == match ? 'block' : 'none';
        }

        // import {MDCFloatingLabel} from '@material/floating-label';

    </script>

    <!-- <script src="text/javascript" src="edit.js"></script> -->

</head>

<body class="mm-login">
    <!-- Setup Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

    <script>
        var config = {
            apiKey: "AIzaSyDkJap-l-nEEa8_Up_fRyBKadFLO8PzKQM",
            authDomain: "miraclemessages-v2.firebaseapp.com",
            databaseURL: "https://miraclemessages-v2.firebaseio.com",
            projectId: "miraclemessages-v2",
            storageBucket: "miraclemessages-v2.appspot.com",
            messagingSenderId: "669586730683"
        };
        app = firebase.initializeApp(config);
    </script>

    <!-- Import headerToColl (dictionary), getURLParams, formatWords,
        escapeSingleQuotes, appendHTML, addFromRef, getData -->
    <script src='utils/database.js'></script>

    <script>
        // Initialize Firebase
        const db = firebase.database();
        var caseID;
        // Search based on the category and query provided.
        function getCaseID() {
            var myform = document.getElementById("newsearch");
            var searchRef = db.ref('volunteers');
            clientquery = $("#clientname").val().toLowerCase().replace(/\s/g, '');
            volquery = $("#email").val();

            searchRef.orderByChild('volunteerContactInfo').equalTo(volquery).on("value", function (snapshot) {
                snapshot.forEach(function (data) {
                    match = data.key.toLowerCase().replace(/\s/g, '');
                    if (match.includes(clientquery)) {
                        // alert(caseID);
                        caseID = data.key;
                        alert(caseID);
                    }
                    return;
                });
            });
        }

        // Write altered data to the database.
        function writeData() {

            // case status and reunion status
            var de = document.getElementById("delivstatus").value;
            var re = document.getElementById("reunionstatus").value;
            // get notes to add
            var lovedonenote = $("#lovedonenote").val();
            var casenotes = [];

            var notes = document.getElementsByClassName("note");
            for (let i = 0; i < notes.length; i++) {
                if (notes[i] != null) {
                    casenotes.push(notes[i].value);
                }
            }
            // Collect the current date time
            var today = new Date;
            var sec = today.getSeconds();
            var min = today.getMinutes();
            var hr = today.getHours();
            var day = today.getDate();
            var month = today.getMonth() + 1;
            var year = today.getFullYear();

            var dateTime = hr + ':' + min + ':' + sec + '::' + month + '/' + day + '/' + year;
            // get case ID
            getCaseID();
            // add it to the 'proposed' queue for an admin to approve it.

            db.ref('proposed/id').once('value').then(function (snapshot) {
                // Get the next proposal ID. The '+ 1 - 1' is to convert null
                // to 0 becuase if the 'proposed' collection is not in the
                // database, then 'proposed/id' will be null.
                proposalID = snapshot.val() + 1 - 1; // ? 
                // console.log(caseID);
                // Update delivery status and reunion status.
                path = 'cases/' + caseID
                let newData = {};
                newData['deliverStatus'] = de;
                newData['reunionStatus'] = re;

                // // Enqueue the proposed edit to be approved by admin.


                //            // Update the proposal ID.
                proposalID += 1
                db.ref('proposed').update({ id: proposalID });

                if (lovedonenote != null) {
                    path = 'loved_ones/' + caseID;
                    let newData = {};
                    newData['lastConnected'] = lovedonenote;
                    newData['dateTime'] = dateTime;
                    db.ref('proposed/' + proposalID + '/' + path).set(newData);
                    db.ref('proposed/' + proposalID).update({ caseID: caseID });
                }

                // Update loved one note.
                // Update notes.
                if (casenotes != null) {
                    path = 'notes/' + caseID;
                    let newData = {};
                    newData['note'] = notes;
                    db.ref('proposed/' + proposalID + '/' + path).set(newData);
                    db.ref('proposed/' + proposalID).update({ caseID: caseID });
                }


            });
        }

    </script>

    <section class="header">
        <svg class="mm-logo" version="1.0" xmlns="http://www.w3.org/2000/svg" width="225.000000pt" height="100pt" viewBox="0 0 225.000000 225.000000"
            preserveAspectRatio="xMidYMid meet">
            <g transform="translate(0.000000,250.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
                <path d="M725 1500 l-399 -400 39 -40 39 -40 56 55 c31 30 59 55 63 55 4 0 7
    -151 7 -335 l0 -335 595 0 595 0 0 335 c0 184 3 335 7 335 4 0 32 -25 63 -55
    l56 -55 39 40 40 40 -400 400 -400 400 -400 -400z m605 35 l195 -195 -400 0
    -400 0 195 195 c107 107 199 195 205 195 6 0 98 -88 205 -195z m-3 -512 l-197
    -198 -197 198 -198 197 395 0 395 0 -198 -197z m33 -128 c129 129 238 235 242
    235 5 0 8 -124 8 -275 l0 -275 -480 0 -480 0 0 277 0 278 238 -238 237 -237
    235 235z" />
            </g>
        </svg>
        <h1>MIRACLE MESSAGES</h1>
    </section>
    <p>Please fill out the following questionnaire about the case you've been working on. </p>

    <form id="updateform">

        <!-- Client name -->
        <div class="mdc-text-field">
            <input type="text" id="clientname" class="mdc-text-field__input" aria-controls="clientname-helper-text" aria-describedby="clientname-helper-text"
                required>
            <label for="clientname" class="mdc-floating-label">Client name</label>
            <div class="mdc-line-ripple"></div>
        </div>
        <div class="mdc-text-field-helper-line">
            <div id="clientname-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
                This should match the name on the case record EXACTLY.
            </div>
        </div>
        <!-- Volunteer name -->
        <div class="mdc-text-field">
            <input type="text" id="volname" class="mdc-text-field__input" aria-controls="volname-helper-text" aria-describedby="volname-helper-text">
            <label for="volname" class="mdc-floating-label" required>Volunteer name</label>
            <div class="mdc-line-ripple"></div>
        </div>
        <div class="mdc-text-field-helper-line">
            <div id="volname-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
                Volunteer name (this should be the volunteer or student responsible for the case)
            </div>
        </div>
        <!-- Volunteer e-mail -->
        <div class="mdc-text-field">
            <input type="text" id="email" class="mdc-text-field__input" aria-controls="email-helper-text" aria-describedby="email-helper-text"
                required>
            <label for="email" class="mdc-floating-label">Volunteer e-mail</label>
            <div class="mdc-line-ripple"></div>
        </div>

        <!-- Date-->
        <div class="mdc-text-field">

            <input type="text" id="datepicker" class="form-control" required>
            </p>
            <label for="date" class="mdc-floating-label">MM/DD/YYYY</label>

            <div class="mdc-line-ripple"></div>
        </div>
        <!-- Case status-->
        <!-- <div class="mdc-form-field" > -->

        <!-- <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" checked name="one">

                    <div class="mdc-radio__background">
                      <div class="mdc-radio__outer-circle"></div>
                      <div class="mdc-radio__inner-circle"></div>
                    </div>
                    
              </div>
                  <label for="radio-1">Delivered</label>

                  <div class="mdc-radio" >
                    <input class="mdc-radio__native-control" type="radio">
                    <div class="mdc-radio__background">
                      <div class="mdc-radio__outer-circle"></div>
                      <div class="mdc-radio__inner-circle"></div>
                    </div>
                  </div>
                  <label for="radio-2">Undelivered</label> -->
        <!-- <input type="radio" name="casestatus" id="case-delivered">
                <label for="case-delivered">Delivered</label>
    
      
      <input type="radio" name="casestatus" id="case-undelivered">
        <label for="case-undelivered">Undelivered</label>
        <input type="radio" name="casestatus" id="other">
                <label for="other">Other</label>
                <div class="reveal-if-active"> -->
        <label for="defaultSelect">Delivery Status. </label>
        <small id="defaultRegisterFormPhoneHelpBlock" class="form-text text-muted mb-4"> If you have been able to reach the loved one, please mark "delivered" below. Otherwise, select "undelivered".
        </small>
        <select id="delivstatus" class="browser-default custom-select mb-4" onchange="showDiv('casemore', this, 'delivered')" required>
            <option value="" disabled="">Choose option</option>
            <option value="delivered" selected="">Delivered</option>
            <option value="undelivered">Undelivered</option>
            <option value="other">Not applicable/other</option>
        </select>
        <div id="casemore">
            <label for="lovedonenote">How did you manage to connect with the loved one? Please include the phone number that worked, the fb page url,
                the email address, etc.
                <br>
                <b>This is important! We follow up with the loved ones post-reunion, so we need correct contact information!</b>
            </label>

            <textarea class="form-control rounded-0" id="lovedonenote" rows="5" placeholder=""></textarea>
        </div>
        </div>
        <label for="defaultSelect">Reunion Status. Has this client been reunited with the loved one yet? </label>
        <small id="defaultRegisterFormPhoneHelpBlock" class="form-text text-muted mb-4"> If you have been able to connect the client with the loved one, please select "reunited" below. If not, please select
            the best answer.
        </small>
        <select id="reunionstatus" class="browser-default custom-select mb-4" onchange="showDiv('reunionmore', this, 'reunited')"
            required>
            <option value="" selected="">Choose option</option>
            <option value="reunited">Reunited</option>
            <option value="notyetreunited">Not yet reunited</option>
            <option value="declined">Declined</option>
            <option value="other">Not applicable/other</option>
        </select>
        <div id="reunionmore">
            <label for="reunionnote">Please describe the reunion outcome in 1-2 sentences.
                <br>
                <b>This is important--we really to be able to tell our success stories! We would really like to know as much
                    as you can tell us about the reunion and its impact.</b>
            </label>

            <textarea class="note" id="reunionnote" rows="5" placeholder=""></textarea>
        </div>
        <textarea class="note" id="note1" rows="3" placeholder="What steps have you taken to solve this case?" required></textarea>

        <textarea class="note" id="note2" rows="3" placeholder="What is your planned next step to solve this case?" required></textarea>
        <textarea class="note" id="note3" rows="3" placeholder="What questions do you have, especially those that may be preventing you from taking the next step?"></textarea>
        <textarea class="note" id="note4" rows="3" placeholder="What help, if any, do you need from others? 
        "></textarea>

        <button class="btn btn-info btn-block" type="submit" onclick="writeData()">Send</button>

        <!-- </div>  -->

        <!-- <select id="defaultSelect" class="browser-default custom-select mb-4" onchange="showDiv('casemore', this)">
        <option value="" selected="">Choose option</option>
        <option value="1">Delivered</option>
        <option value="2">Undelivered</option>
        <option value="3">Not applicable/other</option>
    </select> -->

    </form>


</body>

</html>